<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nexus — Enterprise Dashboard (Demo)</title>

  <!-- Bootstrap 5 (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body { background:#f4f6f9; }
    .card { border-radius:10px; box-shadow:0 2px 6px rgba(15,20,30,0.06); }
    .stat-small { font-weight:700; font-size:1.05rem; }
    .spark-canvas { height:48px !important; }
    .ai-panel { position: sticky; top: 1rem; }
    .badge-sev-critical { background:#ff4d4f; color:white; }
    .badge-sev-warning { background:#ffb020; color:#000; }
    .badge-sev-info { background:#5b8def; color:white; }
    .muted-small { color:#6c757d;font-size:.9rem; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark mb-3">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Nexus System Dashboard — Demo</a>
    <div class="text-white small">Enterprise look — Demo</div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row gx-3">

    <!-- LEFT: MAIN CONTENT (8) -->
    <div class="col-lg-8">

      <!-- TOP STATS ROW -->
      <div class="row g-3 mb-3">
        <div class="col-6 col-md-3">
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="muted-small">CPU</div>
                <div class="stat-small" id="stat-cpu">—</div>
              </div>
              <canvas id="spark-cpu" class="spark-canvas"></canvas>
            </div>
            <div class="mt-2 muted-small">Latency: <span id="stat-latency">—</span></div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="muted-small">Memory</div>
                <div class="stat-small" id="stat-mem">—</div>
              </div>
              <canvas id="spark-mem" class="spark-canvas"></canvas>
            </div>
            <div class="mt-2 muted-small">Active: <span id="stat-active">—</span></div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="muted-small">Disk%</div>
                <div class="stat-small" id="stat-disk">—</div>
              </div>
              <canvas id="spark-disk" class="spark-canvas"></canvas>
            </div>
            <div class="mt-2 muted-small">Used: <span id="stat-dused">—</span> GB</div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="muted-small">DB</div>
                <div class="stat-small" id="stat-db">—</div>
              </div>
              <canvas id="spark-db" class="spark-canvas"></canvas>
            </div>
            <div class="mt-2 muted-small">Snapshot: <span id="stat-time">—</span></div>
          </div>
        </div>
      </div>

      <!-- MAIN TIMESERIES + Controls -->
      <div class="card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div><h5 class="mb-0">CPU / Memory Over Time</h5><div class="muted-small">Last 10 points (demo)</div></div>
          <div>
            <button class="btn btn-sm btn-outline-primary" id="expand-graph">Fullscreen</button>
            <button class="btn btn-sm btn-outline-secondary" id="refresh-btn">Refresh</button>
          </div>
        </div>
        <canvas id="mainChart" style="height:260px;"></canvas>
      </div>

      <!-- ALERTS / EVENTS -->
      <div class="card p-3 mb-3">
        <h6>Alerts</h6>
        <ul id="alerts-list" class="list-unstyled mb-0">
          <!-- JS will populate -->
        </ul>
        <div class="mt-3">
          <button class="btn btn-sm btn-outline-danger" id="create-sample">Create sample event</button>
          <small class="ms-2 muted-small">Use sample events to demo the AI suggestion.</small>
        </div>
      </div>

      <!-- Recent AI Suggestions -->
      <div class="card p-3 mb-4">
        <h6>Recent AI Suggestions</h6>
        <div id="ai-recent">No suggestions yet.</div>
      </div>

    </div> <!-- END MAIN -->

    <!-- RIGHT: AI PANEL (4) -->
    <div class="col-lg-4">
      <div class="card p-3 ai-panel">
        <h5>AI Debug Assistant</h5>
        <div class="mb-2 muted-small">Paste an event id from alerts or create a sample event.</div>
        <input id="event-id" class="form-control mb-2" placeholder="paste eventId (eg. ev_xxx)"/>
        <button id="ask-ai" class="btn btn-primary w-100 mb-2">Ask AI for Debug Suggestions</button>
        <div id="ai-result" class="pt-2" style="min-height:80px;">—</div>
      </div>

      <div class="card p-3 mt-3">
        <h6>Integrations</h6>
        <p class="muted-small">Alerts → Slack / Email / PagerDuty (demo)</p>
        <hr/>
        <h6 class="small">Quick actions</h6>
        <button class="btn btn-outline-secondary btn-sm w-100 mb-2" id="export-diag">Export diag bundle</button>
        <button class="btn btn-outline-secondary btn-sm w-100" id="ack-all">Acknowledge all</button>
      </div>
    </div>

  </div>
</div>

<!-- Fullscreen Modal for chart -->
<div class="modal fade" id="chartModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-fullscreen-sm-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Full-screen Chart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <canvas id="fullChart" style="height:70vh;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------- helper: fetch metrics ---------- */
async function fetchMetrics() {
  try {
    const res = await fetch('/api/metrics');
    if (!res.ok) throw new Error('metrics failed');
    return await res.json();
  } catch (e) {
    return {ok:false, db:false, time: new Date().toISOString(), series: {cpu:[],mem:[]}, alerts: []};
  }
}

/* ---------- initial rendering & Chart.js setup ---------- */
let mainChart, fullChart;
let sparkCpu, sparkMem, sparkDisk, sparkDb;

function makeSpark(ctx, data, color='#3b82f6') {
  return new Chart(ctx, {
    type:'line',
    data:{labels: data.map((_,i)=>i), datasets:[{data, borderWidth:1, pointRadius:0, tension:0.3, borderColor:color}]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}}
  });
}

function makeMainChart(ctx, labels, cpuData, memData) {
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'CPU %', data: cpuData, borderColor: '#ff6b6b', backgroundColor:'rgba(255,107,107,0.05)', tension:0.3 },
        { label: 'Memory %', data: memData, borderColor: '#3b82f6', backgroundColor:'rgba(59,130,246,0.05)', tension:0.3 }
      ]
    },
    options: { maintainAspectRatio:false, interaction:{mode:'index'}, plugins:{legend:{position:'top'}} }
  });
}

/* ---------- update UI with fetched metrics ---------- */
async function refreshUI() {
  const m = await fetchMetrics();
  // top small stats
  document.getElementById('stat-cpu').innerText = m.series?.cpu?.slice(-1)[0] ?? '—';
  document.getElementById('stat-mem').innerText = m.series?.mem?.slice(-1)[0] ?? '—';
  document.getElementById('stat-disk').innerText = m.disk_percent ?? '—';
  document.getElementById('stat-dused').innerText = m.disk_used ?? '—';
  document.getElementById('stat-active').innerText = m.active_sessions ?? '—';
  document.getElementById('stat-latency').innerText = (m.latency_ms ?? '—') + 'ms';
  document.getElementById('stat-db').innerText = m.db ? 'OK' : 'DOWN';
  document.getElementById('stat-time').innerText = new Date(m.time).toLocaleString();

  // alerts
  const alist = document.getElementById('alerts-list');
  alist.innerHTML = '';
  (m.alerts || []).slice(0,8).forEach(a=>{
    const li = document.createElement('li');
    const badgeClass = a.level === 'Critical' ? 'badge-sev-critical' : (a.level==='Warning' ? 'badge-sev-warning' : 'badge-sev-info');
    li.innerHTML = `<div class="d-flex justify-content-between align-items-start">
      <div><span class="badge ${badgeClass} me-2">${a.level}</span> <strong>${a.title}</strong><div class="muted-small">${a.time}</div></div>
      <div><button class="btn btn-sm btn-link" data-id="${a.id}" onclick="copyId(this)">Copy</button></div>
    </div>`;
    alist.appendChild(li);
  });

  // chart data update
  const labels = (m.series?.labels) || [];
  const cpu = (m.series?.cpu) || [];
  const mem = (m.series?.mem) || [];

  if (!mainChart) {
    mainChart = makeMainChart(document.getElementById('mainChart'), labels, cpu, mem);
  } else {
    mainChart.data.labels = labels;
    mainChart.data.datasets[0].data = cpu;
    mainChart.data.datasets[1].data = mem;
    mainChart.update();
  }

  // sparks
  if (!sparkCpu) sparkCpu = makeSpark(document.getElementById('spark-cpu'), cpu.slice(-10), '#ff6b6b');
  else { sparkCpu.data.datasets[0].data = cpu.slice(-10); sparkCpu.update(); }

  if (!sparkMem) sparkMem = makeSpark(document.getElementById('spark-mem'), mem.slice(-10), '#3b82f6');
  else { sparkMem.data.datasets[0].data = mem.slice(-10); sparkMem.update(); }

  if (!sparkDisk) sparkDisk = makeSpark(document.getElementById('spark-disk'), (m.series?.disk||[]).slice(-10), '#8b5cf6');
  else { sparkDisk.data.datasets[0].data = (m.series?.disk||[]).slice(-10); sparkDisk.update(); }

  if (!sparkDb) sparkDb = makeSpark(document.getElementById('spark-db'), (m.series?.db_ok? [1,1,1,1] : [0,0,0,0]), '#10b981');
  else { sparkDb.update(); }
}

/* ---------- helper actions ---------- */
function copyId(btn){
  const id = btn.getAttribute('data-id');
  navigator.clipboard?.writeText(id || '');
  btn.innerText = 'Copied';
  setTimeout(()=>btn.innerText='Copy',1200);
}

document.getElementById('refresh-btn').addEventListener('click', () => refreshUI());
document.getElementById('create-sample').addEventListener('click', async () => {
  await fetch('/api/create_sample', {method:'POST'});
  await refreshUI();
});
document.getElementById('ask-ai').addEventListener('click', async () => {
  const eid = document.getElementById('event-id').value.trim();
  if (!eid) { alert('paste event id or create sample'); return; }
  const rBox = document.getElementById('ai-result');
  rBox.innerHTML = '<div class="muted-small">Asking AI…</div>';
  const resp = await fetch('/api/ai/suggest', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({event_id: eid})});
  const data = await resp.json();
  rBox.innerHTML = `<pre style="white-space:pre-wrap">${data.suggestion || data.error || 'No result'}</pre>`;
  // append to recent
  const recent = document.getElementById('ai-recent');
  recent.innerHTML = `<div class="mb-2"><strong>${data.summary||'AI Suggestion'}</strong><div class="muted-small">${data.suggestion?.slice(0,200) || ''}</div></div>` + recent.innerHTML;
});

/* fullscreen graph handler */
document.getElementById('expand-graph').addEventListener('click', ()=>{
  const modal = new bootstrap.Modal(document.getElementById('chartModal'));
  modal.show();
  setTimeout(()=> {
    // copy mainChart data to fullChart
    if (window.fullChart) window.fullChart.destroy();
    const ctx = document.getElementById('fullChart').getContext('2d');
    window.fullChart = new Chart(ctx, Object.assign({}, mainChart.config, { options: Object.assign({}, mainChart.options, { maintainAspectRatio:false }) }));
  },250);
});

/* initial load */
refreshUI();
setInterval(refreshUI, 8000); // refresh every 8 seconds (demo)
</script>
</body>
</html>
