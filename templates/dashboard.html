<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nexus Demo — Dashboard</title>

  <!-- Tailwind CDN (quick demo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small custom dark tweaks */
    :root { color-scheme: dark; }
    body { background: #0b1220; color: #cbd5e1; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 6px 24px rgba(2,6,23,0.6); border: 1px solid rgba(255,255,255,0.03); }
    .muted { color: #94a3b8; }
    .positive { color: #34d399; } /* green */
    .warn { color: #f59e0b; } /* amber */
    .danger { color: #fb7185; } /* red */
  </style>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="antialiased">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold text-white">Nexus System — Demo</h1>
        <p class="muted text-sm">AI Debug Assistant • Live demo</p>
      </div>
      <div class="flex items-center space-x-3">
        <button id="btn-create" class="px-4 py-2 bg-sky-600 text-white rounded shadow">Create sample event</button>
        <button id="btn-refresh" class="px-4 py-2 border border-slate-700 text-slate-200 rounded">Refresh</button>
      </div>
    </header>

    <!-- Top cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="card p-4 rounded-lg">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-sm muted">Uptime</div>
            <div class="text-2xl font-bold positive" id="uptime">—</div>
          </div>
          <div class="text-right">
            <div class="text-sm muted">Active Alerts</div>
            <div class="text-xl font-semibold warn" id="alerts-count">—</div>
          </div>
        </div>
        <div class="mt-3 muted text-sm">Quick status summary</div>
      </div>

      <div class="card p-4 rounded-lg">
        <div class="text-sm muted">Avg API Latency</div>
        <div class="text-2xl font-bold" id="latency">— ms</div>
        <div class="mt-3">
          <canvas id="chart-cpu" height="100"></canvas>
        </div>
      </div>

      <div class="card p-4 rounded-lg">
        <div class="text-sm muted">Error Rate</div>
        <div class="text-2xl font-bold danger" id="error-rate">—</div>
        <div class="mt-3 muted text-sm">Recent incidents</div>
        <ul id="recent-incidents" class="mt-2 text-sm space-y-1"></ul>
      </div>
    </div>

    <!-- Main grid: left charts, right AI panel -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 space-y-4">
        <div class="card p-4 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-lg font-semibold">API Performance Trends</h2>
              <div class="muted text-sm">Last few samples</div>
            </div>
            <div class="muted text-sm">Auto-updating demo</div>
          </div>
          <div class="mt-4">
            <canvas id="chart-trend" height="120"></canvas>
          </div>
        </div>

        <div class="card p-4 rounded-lg">
          <h3 class="text-lg font-semibold">Events Table (recent)</h3>
          <div class="mt-3">
            <table class="w-full text-sm">
              <thead class="text-left muted text-xs">
                <tr><th>ID</th><th>Type</th><th>Message</th><th>Time</th></tr>
              </thead>
              <tbody id="events-table" class="divide-y divide-slate-700"></tbody>
            </table>
          </div>
        </div>
      </div>

      <aside class="space-y-4">
        <div class="card p-4 rounded-lg">
          <h3 class="text-lg font-semibold">AI Insights</h3>
          <p class="muted text-sm">Suggestions generated by demo AI / local heuristic</p>
          <div id="ai-suggestions" class="mt-3 space-y-3"></div>
        </div>

        <div class="card p-4 rounded-lg">
          <h3 class="text-lg font-semibold">Ask AI (quick)</h3>
          <textarea id="ai-input" rows="3" class="w-full p-2 bg-slate-900 rounded text-sm" placeholder="Paste event id or message..."></textarea>
          <div class="mt-2 flex gap-2">
            <button id="btn-ask" class="px-3 py-2 bg-emerald-600 rounded text-white">Ask AI</button>
            <button id="btn-clear" class="px-3 py-2 border rounded text-sm muted">Clear</button>
          </div>
          <div id="ai-response" class="mt-3 text-sm muted"></div>
        </div>
      </aside>
    </div>

    <footer class="mt-6 muted text-sm">
      Nexus Demo • For investor presentation only — data simulated.
    </footer>
  </div>

<script>
  // Helper: fetch JSON with error handling
  async function jfetch(url, opts) {
    try {
      const res = await fetch(url, opts || {});
      return await res.json();
    } catch (e) {
      console.warn("fetch failed", url, e);
      return null;
    }
  }

  // Chart objects
  let trendChart = null, cpuChart = null;

  function initCharts() {
    const ctx = document.getElementById('chart-trend').getContext('2d');
    trendChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'CPU %', data: [], tension: 0.3, fill: true }] },
      options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { beginAtZero: true } } }
    });

    const ctx2 = document.getElementById('chart-cpu').getContext('2d');
    cpuChart = new Chart(ctx2, {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Mem %', data: [] }] },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  }

  // Update UI from /api/metrics
  async function refreshMetrics() {
    const m = await jfetch('/api/metrics');
    if (!m || !m.ok) return;
    // uptime & quick cards
    document.getElementById('uptime').innerText = Math.round(99 + Math.random() * 0.99) + '%';
    document.getElementById('latency').innerText = Math.round(100 + Math.random() * 200) + ' ms';
    document.getElementById('alerts-count').innerText = Math.floor(Math.random() * 10);

    // trend chart: use metrics if provided
    const labels = (m.series && m.series.labels) ? m.series.labels.map(t => new Date(t*1000).toLocaleTimeString()) : Array.from({length:10}, (_,i)=>i);
    const cpu = (m.series && m.series.cpu) ? m.series.cpu : Array.from({length:10}, ()=>Math.round(10+Math.random()*60));
    const mem = (m.series && m.series.mem) ? m.series.mem : Array.from({length:10}, ()=>Math.round(20+Math.random()*70));

    if (trendChart) {
      trendChart.data.labels = labels;
      trendChart.data.datasets[0].data = cpu;
      trendChart.update();
    }
    if (cpuChart) {
      cpuChart.data.labels = labels;
      cpuChart.data.datasets[0].data = mem;
      cpuChart.update();
    }

    // events demo: fetch recent events by calling /api/ingest? (we will also fetch events stored)
    // We will try reading 'events' from the /api/create_sample result (create_sample persists).
    const eventsTbl = document.getElementById('events-table');
    eventsTbl.innerHTML = '';
    try {
      // Try reading seeded events by calling a backend read route; if not available, show synthetic
      // We will try /api/metrics response to show db status
      if (m.db) {
        // Try to list recent events using a simple approach: call /api/create_sample (this returns event payload only)
        // Instead we simulate a list using the seeded demo ids:
        const demoIds = ['ev_demo_1','ev_demo_2','ev_demo_3','ev_demo_4','ev_demo_5'];
        demoIds.forEach(id => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="py-2 text-xs">${id}</td><td class="py-2 text-xs">INFO</td><td class="py-2 text-xs muted">Demo event message for ${id}</td><td class="py-2 text-xs muted">now</td>`;
          eventsTbl.appendChild(tr);
        });
      } else {
        // Synthetic fallback rows
        for (let i=0;i<5;i++) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="py-2 text-xs">demo_${i}</td><td class="py-2 text-xs">WARN</td><td class="py-2 text-xs muted">No DB: showing synthetic</td><td class="py-2 text-xs muted">-</td>`;
          eventsTbl.appendChild(tr);
        }
      }
    } catch (e) {
      console.warn(e);
    }
  }

  // Fetch and display AI suggestions
  async function refreshAISuggestions() {
    const res = await jfetch('/api/ai/suggestions');
    const panel = document.getElementById('ai-suggestions');
    panel.innerHTML = '';
    if (!res || !res.ok || !res.suggestions) {
      panel.innerHTML = `<div class="muted text-sm">No suggestions yet. Create an event to generate one.</div>`;
      return;
    }
    res.suggestions.forEach(s => {
      const d = document.createElement('div');
      d.className = 'p-3 rounded border border-slate-700';
      d.innerHTML = `<div class="font-semibold">${escapeHtml(s.title)}</div><div class="muted text-xs mt-1">${escapeHtml(s.body)}</div><div class="muted text-xs mt-1">${escapeHtml(s.created_at)}</div>`;
      panel.appendChild(d);
    });
  }

  function escapeHtml(str){ return (''+str).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // Wire UI buttons
  async function setupUI() {
    document.getElementById('btn-create').addEventListener('click', async () => {
      const res = await jfetch('/api/ingest', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({event_type: 'ERROR', message: 'Manual test event from Pankaj'})});
      if (res && res.ok) {
        alert('Event created: ' + res.event_id);
        await refreshAISuggestions();
        await refreshMetrics();
      } else {
        alert('Failed to create event (see console).');
      }
    });

    document.getElementById('btn-refresh').addEventListener('click', async () => {
      await refreshMetrics();
      await refreshAISuggestions();
    });

    document.getElementById('btn-ask').addEventListener('click', async () => {
      const txt = document.getElementById('ai-input').value || 'ev_demo_1';
      const payload = { event_id: txt };
      const res = await jfetch('/api/ai/suggest', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
      const out = document.getElementById('ai-response');
      if (res && res.ok) {
        out.innerHTML = `<div class="font-semibold">[${res.provider || 'demo'}]</div><div class="muted text-sm">${escapeHtml(res.suggestion || res.analysis || '')}</div>`;
        await refreshAISuggestions();
      } else {
        out.innerText = 'AI request failed';
      }
    });

    document.getElementById('btn-clear').addEventListener('click', () => {
      document.getElementById('ai-input').value = '';
      document.getElementById('ai-response').innerHTML = '';
    });
  }

  // Init page
  (function () {
    initCharts();
    setupUI();
    refreshMetrics();
    refreshAISuggestions();
    // auto refresh
    setInterval(async () => { await refreshMetrics(); await refreshAISuggestions(); }, 8000);
  })();
</script>
</body>
</html>
